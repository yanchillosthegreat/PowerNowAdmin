@page
@model Pages.Take.IndexModel
@{
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<div class="row">
    @Html.AntiForgeryToken()
    @if(!Model.Session?.IsActive ?? true)
    {
        <div class="row">
            <div class="text-center m-t-lg m-b-lg">
                <p class="p-power-now-bold-13">ВВЕДИ НОМЕР АВТОМАТА</p>
            </div>
        </div>

        <div class="col-md-12">
            <form method="POST" id="enter-equipment-code-form">
                <span class="text-center text-danger"></span>
                <div class="form-group">
                    <input type="text" id="equipment-code-input" class="form-control" placeholder="X X X X"
                           required="" data-mask="9_9_9_9"
                           style="border-bottom-color: #F58319; border-width: 0px;
                              border-bottom-width: 2px; background-color: transparent;
                              text-align: center">
                </div>
                <button type="submit" id="equipment-code-submit"
                        class="ladda-button btn btn-primary-orange full-width m-b m-t-lg pb-button-shadow"
                        data-style="zoom-in">
                    Продолжить
                </button>
            </form>
        </div>
    }
    else
    {
        <div class="col-md-12 p-lg">
            <div class="col-md-12">
                <img src="~/css/patterns/logo.png" class="img-responsive" style="width: 158px; height: 74px; margin:auto" />
            </div>
        </div>
        <div class="animated fadeInRight text-center" id="timer-equipment-block">
            <div>
                <input id="session-duration" type="hidden" value="@Model.SessionDuration" />
                <pre id="timer-text" class="p-power-now-normal"></pre>
            </div>
        </div>
        <div class="row">
            <div class="col text-center">
                <a class="btn btn-primary-orange m-b" style="width: 219px" href='@Url.Page("take/index")'>ценовые условия</a>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <img src="~/css/patterns/powerbankImage.png" class="img-responsive rotatePowerbankImage" style="width: 223px; height: 231px; margin:auto" />
            </div>
        </div>
    }

    <script type="text/javascript">

            $(document).ready(function(e){
                var timerText = $("#timer-text");

                var elapsed_seconds = parseInt($("#session-duration").val());
                setInterval(function() {
                    elapsed_seconds = elapsed_seconds + 1;
                    timerText.text(get_elapsed_time_string(elapsed_seconds));
                }, 1000);

                setInterval(check, 5000);

            });

            function check() {
                var token = $('input[name="__RequestVerificationToken"]').val()
                var request = $.ajax({
                    url: "/take?handler=check",
                    type: "POST",
                    dataType: "json",
                    data: {
                        __RequestVerificationToken: token
                    },
                    success: function (response) {
                        switch (response.code) {
                            case 200:
                                switch (response.message) {
                                    case "1":
                                        break;
                                    case "0":
                                        //alert("Session is over");
                                        //location.reload();
                                        break;
                                    default:
                                        alert(response.message);
                                        break;
                                }
                                break;
                            default:
                                alert(response.message);
                                break;
                        }
                    }
                });
            }


            function get_elapsed_time_string(total_seconds) {
                function pretty_time_string(num) {
                    return ( num < 10 ? "0" : "" ) + num;
                }

                var hours = Math.floor(total_seconds / 3600);
                total_seconds = total_seconds % 3600;

                var minutes = Math.floor(total_seconds / 60);
                total_seconds = total_seconds % 60;

                var seconds = Math.floor(total_seconds);

                // Pad the minutes and seconds with leading zeros, if required
                hours = pretty_time_string(hours);
                minutes = pretty_time_string(minutes);
                seconds = pretty_time_string(seconds);

                // Compose the string for display
                var currentTimeString = hours + "  :  " + minutes + "  :  " + seconds;

                return currentTimeString;
            }
        </script>

</div>