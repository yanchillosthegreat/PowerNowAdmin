@page
@model Pages.Take.IndexModel
@{
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<script type="text/javascript">
    function inInputNumber(evt) {
        var ch = String.fromCharCode(evt.which);
        if (!(/[0-9]/.test(ch))) {
            evt.preventDefault();
        }
    }

    $(document).ready(function () {
        $(".c1").on("keyup", function () {
            if ($(this).val().length >= parseInt($(this).attr("maxlength"), 10))
                $(".c2").focus();
        })
        $(".c2").on("keyup", function () {
            if ($(this).val().length == 0) {
                $(".c1").focus();
                return;
            }
            if ($(this).val().length >= parseInt($(this).attr("maxlength"), 10))
                $(".c3").focus();
        })
        $(".c3").on("keyup", function () {
            if ($(this).val().length == 0) {
                $(".c2").focus();
                return;
            }
            if ($(this).val().length >= parseInt($(this).attr("maxlength"), 10))
                $(".c4").focus();
        })
        $(".c4").on("keyup", function () {
            if ($(this).val().length == 0) {
                $(".c3").focus();
                return;
            }
        })
    });
</script>

<div class="row">
    @Html.AntiForgeryToken()
    @if(!Model.Session?.IsActive ?? true)
    {
        <div class="row">
            <div class="text-center m-b-lg">
                <p class="p-power-now-bold-13">ВВЕДИ НОМЕР АВТОМАТА</p>
            </div>
        </div>


        <div class="row">
        <form method="POST" id="enter-equipment-code-form">
            <div class="row">
                <div class="col-xs-3">
                    <input type="text" name="c1" id="equipment-code-input1" maxLength="1" size="1" min="0" max="9" pattern="[0-9]"
                   class="form-control pb-input-code-style c1" placeholder="X" required=""
                           onkeypress="inInputNumber(event)">
                </div>
                <div class="col-xs-3">
                    <input type="text" name="c2" id="equipment-code-input2" maxLength="1" size="1" min="0" max="9" pattern="[0-9]"
                   class="form-control pb-input-code-style c2" placeholder="X" required=""
                           onkeypress="inInputNumber(event)">
                </div>
                <div class="col-xs-3">
                    <input type="text" name="c3" id="equipment-code-input3" maxLength="1" size="1" min="0" max="9" pattern="[0-9]"
                   class="form-control pb-input-code-style c3" placeholder="X" required=""
                           onkeypress="inInputNumber(event)">
                </div>
                <div class="col-xs-3">
                    <input type="text" name="c4" id="equipment-code-input4" maxLength="1" size="1" min="0" max="9" pattern="[0-9]"
                   class="form-control pb-input-code-style c4" placeholder="X" required=""
                           onkeypress="inInputNumber(event)">
                </div>
            </div>
            <button type="submit" id="equipment-code-submit"
                    class="ladda-button btn btn-primary-orange btn-block m-b m-t-lg pb-button-shadow"
                    data-style="zoom-in">
                Продолжить
            </button>
        </form>
            </div>

        <div class="row m-t-lg m-b-xl"></div>
        <div class="row m-t-lg m-b-xl"></div>

        <div class="row m-b-lg">
            <div class="col-xs-12 pb-no-left-padding">
                <span class="p-power-now-normal">Не рядом с оборудованием?</span>
                <span class="p-power-now-normal" style="font-weight: bold;">Найди ближайший на карте</span>
            </div>
        </div>

        <div class="row">
            <a class="btn btn-primary-orange btn-block pb-button-shadow" href='@Url.Page("/map/index")'>найти</a>
        </div>
    }
    else
    {
        <div class="row m-t-lg">
            <img src="~/css/patterns/logo.png" class="img-responsive" style="width: 167px; height: 78px; margin: auto" />
        </div>
        <div class="row m-t-lg">

    </div>
        <div class="row text-center m-t-lg" id="timer-equipment-block">
            <div>
                <input id="session-duration" type="hidden" value="@Model.SessionDuration" />
                <pre id="timer-text" class="p-power-now-normal"></pre>
            </div>
        </div>
        <div class="row m-t-lg">

    </div>
        <div class="row">
            <div class="col-xs-10 pb-no-left-padding">
                <span class="p-power-now-normal">Зарегистрируйся на сайте и получи </span>
                <span class="p-power-now-normal" style="font-weight: bold;">49 баллов</span>
            </div>
        </div>
        <div class="row m-t-lg">
            <div class="col-12">
                <img src="~/css/patterns/powerbank_holder.gif" class="img-responsive" style="width: 334px; height: 291px; margin:auto" />
            </div>
        </div>
    }

    <script type="text/javascript">

            $(document).ready(function(e){
                var timerText = $("#timer-text");

                var elapsed_seconds = parseInt($("#session-duration").val());
                setInterval(function() {
                    elapsed_seconds = elapsed_seconds + 1;
                    timerText.text(get_elapsed_time_string(elapsed_seconds));
                }, 1000);

                setInterval(check, 5000);

            });

            function check() {
                var token = $('input[name="__RequestVerificationToken"]').val()
                var request = $.ajax({
                    url: "/take?handler=check",
                    type: "POST",
                    dataType: "json",
                    data: {
                        __RequestVerificationToken: token
                    },
                    success: function (response) {
                        switch (response.code) {
                            case 200:
                                switch (response.message) {
                                    case "1":
                                        break;
                                    case "0":
                                        //alert("Session is over");
                                        //location.reload();
                                        break;
                                    default:
                                        alert(response.message);
                                        break;
                                }
                                break;
                            default:
                                alert(response.message);
                                break;
                        }
                    }
                });
            }


            function get_elapsed_time_string(total_seconds) {
                function pretty_time_string(num) {
                    return (num < 10 ? "0\u00A0\u00A0" : "") + num.toString().split('').join('\u00A0\u00A0');
                }

                var hours = Math.floor(total_seconds / 3600);
                total_seconds = total_seconds % 3600;

                var minutes = Math.floor(total_seconds / 60);
                total_seconds = total_seconds % 60;

                var seconds = Math.floor(total_seconds);

                // Pad the minutes and seconds with leading zeros, if required
                hours = pretty_time_string(hours);
                minutes = pretty_time_string(minutes);
                seconds = pretty_time_string(seconds);

                // Compose the string for display
                var currentTimeString = hours + "\u00A0  :  \u00A0" + minutes + "\u00A0  :  \u00A0" + seconds;

                return currentTimeString;
            }
        </script>

</div>